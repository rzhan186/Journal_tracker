# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: PubMed Subscription Scheduler

on:
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:

# âœ… ADD: Required permissions for GitHub API access
permissions:
  contents: read
  issues: write
  actions: read

env:
  PYTHON_VERSION: '3.13'
  LOG_LEVEL: 'INFO'

jobs:
  send-subscription-updates:  
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create logs directory
      run: |
        mkdir -p logs
        echo "Scheduler started at $(date)" > logs/scheduler.log
    
    - name: Validate environment
      run: |
        echo "ğŸ” Validating environment..."
        python -c "
        import os
        required_vars = [
            'SUPABASE_URL', 'SUPABASE_KEY', 
            'BREVO_API_KEY', 'BREVO_SENDER_EMAIL', 'BREVO_SENDER_NAME',
            'DOWNLOAD_SECRET', 'UNSUBSCRIBE_SECRET'
        ]
        missing = [var for var in required_vars if not os.getenv(var)]
        if missing:
            print(f'âŒ Missing environment variables: {missing}')
            exit(1)
        else:
            print('âœ… All environment variables present')
        "
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        BREVO_API_KEY: ${{ secrets.BREVO_API_KEY }}
        BREVO_SENDER_EMAIL: ${{ secrets.BREVO_SENDER_EMAIL }}
        BREVO_SENDER_NAME: ${{ secrets.BREVO_SENDER_NAME }}
        DOWNLOAD_SECRET: ${{ secrets.DOWNLOAD_SECRET }}
        UNSUBSCRIBE_SECRET: ${{ secrets.UNSUBSCRIBE_SECRET }}
    
    - name: Run subscription scheduler
      id: scheduler
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        BREVO_API_KEY: ${{ secrets.BREVO_API_KEY }}
        BREVO_SENDER_EMAIL: ${{ secrets.BREVO_SENDER_EMAIL }}
        BREVO_SENDER_NAME: ${{ secrets.BREVO_SENDER_NAME }}
        DOWNLOAD_SECRET: ${{ secrets.DOWNLOAD_SECRET }}
        UNSUBSCRIBE_SECRET: ${{ secrets.UNSUBSCRIBE_SECRET }}
        GITHUB_RUN_ID: ${{ github.run_id }}
        GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      run: |
        echo "ğŸš€ Starting PubMed Subscription Scheduler..."
        echo "ğŸ“… Run Date: $(date)"
        echo "ğŸ”— Run URL: $GITHUB_RUN_URL"
        echo "=========================="
        
        cd src
        python scheduler.py 2>&1 | tee ../logs/scheduler.log
        
        # Capture exit code
        exit_code=${PIPESTATUS[0]}
        echo "scheduler_exit_code=$exit_code" >> $GITHUB_OUTPUT
        
        if [ $exit_code -eq 0 ]; then
          echo "âœ… Scheduler completed successfully"
        else
          echo "âŒ Scheduler failed with exit code: $exit_code"
        fi
        
        exit $exit_code
    
    # âœ… FIXED: Better output handling
    - name: Generate run summary
      id: summary
      if: always()
      run: |
        echo "ğŸ“Š SCHEDULER RUN SUMMARY" >> logs/summary.txt
        echo "========================" >> logs/summary.txt
        echo "ğŸ“… Date: $(date)" >> logs/summary.txt
        echo "ğŸ”— Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> logs/summary.txt
        echo "ğŸ·ï¸  Commit: ${{ github.sha }}" >> logs/summary.txt
        echo "" >> logs/summary.txt
        
        # Initialize default values
        total_subs="0"
        processed="0"
        sent="0"
        errors="0"
        
        if [ -f logs/scheduler.log ]; then
          # Extract key metrics from logs with better error handling
          total_subs=$(grep -o "Found [0-9]* active subscriptions" logs/scheduler.log | grep -o "[0-9]*" | head -1 || echo "0")
          
          # Extract processed and sent numbers more carefully
          if grep -q "Processing complete:" logs/scheduler.log; then
            processed=$(grep "Processing complete:" logs/scheduler.log | grep -o "[0-9]* processed" | grep -o "[0-9]*" | head -1 || echo "0")
            sent=$(grep "Processing complete:" logs/scheduler.log | grep -o "[0-9]* emails sent" | grep -o "[0-9]*" | head -1 || echo "0")
          fi
          
          errors=$(grep -c "âŒ\|ERROR" logs/scheduler.log || echo "0")
          
          echo "ğŸ“ˆ RESULTS:" >> logs/summary.txt
          echo "  â€¢ Total Subscriptions: $total_subs" >> logs/summary.txt
          echo "  â€¢ Processed: $processed" >> logs/summary.txt
          echo "  â€¢ Emails Sent: $sent" >> logs/summary.txt
          echo "  â€¢ Errors: $errors" >> logs/summary.txt
          echo "" >> logs/summary.txt
          
          # âœ… FIXED: Proper output format
          {
            echo "total_subscriptions=$total_subs"
            echo "emails_sent=$sent"
            echo "errors_count=$errors"
            echo "processed_count=$processed"
          } >> $GITHUB_OUTPUT
          
          # Show recent email sends
          echo "ğŸ“§ RECENT EMAILS SENT:" >> logs/summary.txt
          grep "âœ….*email sent to" logs/scheduler.log | tail -10 >> logs/summary.txt || echo "  No emails found in logs" >> logs/summary.txt
          
          # Show any errors
          if [ "$errors" -gt 0 ]; then
            echo "" >> logs/summary.txt
            echo "âŒ ERRORS:" >> logs/summary.txt
            grep "âŒ\|ERROR" logs/scheduler.log | tail -5 >> logs/summary.txt
          fi
        else
          echo "âŒ No log file found" >> logs/summary.txt
          {
            echo "total_subscriptions=0"
            echo "emails_sent=0"
            echo "errors_count=1"
            echo "processed_count=0"
          } >> $GITHUB_OUTPUT
        fi
        
        # Display summary
        cat logs/summary.txt
    
    - name: Upload scheduler logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: scheduler-logs-${{ github.run_id }}
        path: |
          logs/
          src/*.log
        retention-days: 30
        compression-level: 6
    
    # âœ… FIXED: Better error handling for issue creation
    - name: Create issue on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          let summary = 'Log file not found';
          
          try {
            if (fs.existsSync('logs/summary.txt')) {
              summary = fs.readFileSync('logs/summary.txt', 'utf8');
            }
          } catch (error) {
            console.log('Could not read summary file:', error.message);
            summary = `Error reading summary: ${error.message}`;
          }
          
          const issueBody = `## ğŸš¨ Scheduler Failure Alert
          
          **Run Details:**
          - ğŸ“… Date: ${new Date().toISOString()}
          - ğŸ”— Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - ğŸ·ï¸ Commit: ${{ github.sha }}
          - ğŸ‘¤ Actor: ${{ github.actor }}
          
          **Summary:**
          \`\`\`
          ${summary}
          \`\`\`
          
          **Next Steps:**
          1. Check the [workflow logs](${{github.server_url}}/${{github.repository}}/actions/runs/${{github.run_id}})
          2. Download the log artifacts for detailed analysis
          3. Fix any issues and manually trigger the workflow if needed
          
          **Auto-generated by GitHub Actions**`;
          
          try {
            // Check if issue already exists for today
            const today = new Date().toISOString().split('T')[0];
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'scheduler-failure',
              state: 'open'
            });
            
            const todayIssue = existingIssues.data.find(issue => 
              issue.title.includes(today)
            );
            
            if (!todayIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸš¨ Scheduler Failed - ${today}`,
                body: issueBody,
                labels: ['scheduler-failure', 'bug', 'urgent']
              });
              console.log('âœ… Created failure issue');
            } else {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: todayIssue.number,
                body: `## Additional Failure\n\n${issueBody}`
              });
              console.log('âœ… Updated existing failure issue');
            }
          } catch (error) {
            console.log('âŒ Failed to create/update issue:', error.message);
            // Don't fail the workflow if issue creation fails
          }
    
    - name: Log success metrics
      if: success()
      run: |
        echo "âœ… Scheduler completed successfully!"
        echo "ğŸ“Š Emails sent: ${{ steps.summary.outputs.emails_sent || '0' }}"
        echo "ğŸ“ˆ Processed: ${{ steps.summary.outputs.processed_count || '0' }}"
        echo "ğŸ“Š Check the summary above for detailed metrics"

  # âœ… SIMPLIFIED: Health check job
  health-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    needs: send-subscription-updates
    steps:
    - name: Daily health summary
      run: |
        echo "ğŸ“‹ DAILY HEALTH CHECK"
        echo "===================="
        echo "ğŸ“… Date: $(date)"
        echo "âœ… Scheduler Status: ${{ needs.send-subscription-updates.result }}"
        echo "ğŸ“§ Emails Sent: ${{ needs.send-subscription-updates.outputs.emails_sent || 'Unknown' }}"
        echo "âŒ Errors: ${{ needs.send-subscription-updates.outputs.errors_count || 'Unknown' }}"
        echo ""
        
        if [ "${{ needs.send-subscription-updates.result }}" = "success" ]; then
          echo "ğŸ‰ All systems operational!"
        else
          echo "âš ï¸ Issues detected - check the logs"
        fi