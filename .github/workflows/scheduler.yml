# # yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: PubMed Subscription Scheduler

on:
  schedule:
    # Run every 24 hours at 9:00 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch: # Allows manual triggering

env:
  # Global environment variables
  PYTHON_VERSION: '3.13'
  LOG_LEVEL: 'INFO'

jobs:
  send-subscription-updates:  
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # âœ… NEW: Create logs directory
    - name: Create logs directory
      run: |
        mkdir -p logs
        echo "Scheduler started at $(date)" > logs/scheduler.log
    
    # âœ… NEW: Pre-run validation
    - name: Validate environment
      run: |
        echo "ğŸ” Validating environment..."
        python -c "
        import os
        required_vars = [
            'SUPABASE_URL', 'SUPABASE_KEY', 
            'BREVO_API_KEY', 'BREVO_SENDER_EMAIL', 'BREVO_SENDER_NAME',
            'DOWNLOAD_SECRET', 'UNSUBSCRIBE_SECRET'
        ]
        missing = [var for var in required_vars if not os.getenv(var)]
        if missing:
            print(f'âŒ Missing environment variables: {missing}')
            exit(1)
        else:
            print('âœ… All environment variables present')
        "
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        BREVO_API_KEY: ${{ secrets.BREVO_API_KEY }}
        BREVO_SENDER_EMAIL: ${{ secrets.BREVO_SENDER_EMAIL }}
        BREVO_SENDER_NAME: ${{ secrets.BREVO_SENDER_NAME }}
        DOWNLOAD_SECRET: ${{ secrets.DOWNLOAD_SECRET }}
        UNSUBSCRIBE_SECRET: ${{ secrets.UNSUBSCRIBE_SECRET }}
    
    # âœ… MAIN: Run subscription scheduler with enhanced logging
    - name: Run subscription scheduler
      id: scheduler
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        BREVO_API_KEY: ${{ secrets.BREVO_API_KEY }}
        BREVO_SENDER_EMAIL: ${{ secrets.BREVO_SENDER_EMAIL }}
        BREVO_SENDER_NAME: ${{ secrets.BREVO_SENDER_NAME }}
        DOWNLOAD_SECRET: ${{ secrets.DOWNLOAD_SECRET }}
        UNSUBSCRIBE_SECRET: ${{ secrets.UNSUBSCRIBE_SECRET }}
        GITHUB_RUN_ID: ${{ github.run_id }}
        GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      run: |
        echo "ğŸš€ Starting PubMed Subscription Scheduler..."
        echo "ğŸ“… Run Date: $(date)"
        echo "ğŸ”— Run URL: $GITHUB_RUN_URL"
        echo "=========================="
        
        cd src
        python scheduler.py 2>&1 | tee ../logs/scheduler.log
        
        # Capture exit code
        exit_code=${PIPESTATUS[0]}
        echo "scheduler_exit_code=$exit_code" >> $GITHUB_OUTPUT
        
        if [ $exit_code -eq 0 ]; then
          echo "âœ… Scheduler completed successfully"
        else
          echo "âŒ Scheduler failed with exit code: $exit_code"
        fi
        
        exit $exit_code
    
    # âœ… NEW: Parse and summarize results
    - name: Generate run summary
      if: always()
      run: |
        echo "ğŸ“Š SCHEDULER RUN SUMMARY" >> logs/summary.txt
        echo "========================" >> logs/summary.txt
        echo "ğŸ“… Date: $(date)" >> logs/summary.txt
        echo "ğŸ”— Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> logs/summary.txt
        echo "ğŸ·ï¸  Commit: ${{ github.sha }}" >> logs/summary.txt
        echo "" >> logs/summary.txt
        
        if [ -f logs/scheduler.log ]; then
          # Extract key metrics from logs
          total_subs=$(grep -o "Found [0-9]* active subscriptions" logs/scheduler.log | grep -o "[0-9]*" || echo "0")
          processed=$(grep -o "processed, [0-9]* emails sent" logs/scheduler.log | grep -o "[0-9]*" | head -1 || echo "0")
          sent=$(grep -o "processed, [0-9]* emails sent" logs/scheduler.log | grep -o "[0-9]*" | tail -1 || echo "0")
          errors=$(grep -c "âŒ\|ERROR" logs/scheduler.log || echo "0")
          
          echo "ğŸ“ˆ RESULTS:" >> logs/summary.txt
          echo "  â€¢ Total Subscriptions: $total_subs" >> logs/summary.txt
          echo "  â€¢ Processed: $processed" >> logs/summary.txt
          echo "  â€¢ Emails Sent: $sent" >> logs/summary.txt
          echo "  â€¢ Errors: $errors" >> logs/summary.txt
          echo "" >> logs/summary.txt
          
          # Set outputs for later steps
          echo "total_subscriptions=$total_subs" >> $GITHUB_OUTPUT
          echo "emails_sent=$sent" >> $GITHUB_OUTPUT
          echo "errors_count=$errors" >> $GITHUB_OUTPUT
          
          # Show recent email sends
          echo "ğŸ“§ RECENT EMAILS SENT:" >> logs/summary.txt
          grep "âœ….*email sent to" logs/scheduler.log | tail -10 >> logs/summary.txt || echo "  No emails found in logs" >> logs/summary.txt
          
          # Show any errors
          if [ "$errors" -gt 0 ]; then
            echo "" >> logs/summary.txt
            echo "âŒ ERRORS:" >> logs/summary.txt
            grep "âŒ\|ERROR" logs/scheduler.log | tail -5 >> logs/summary.txt
          fi
        else
          echo "âŒ No log file found" >> logs/summary.txt
        fi
        
        # Display summary
        cat logs/summary.txt
    
    # âœ… NEW: Upload logs (always runs)
    - name: Upload scheduler logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: scheduler-logs-${{ github.run_id }}
        path: |
          logs/
          src/*.log
        retention-days: 30
        compression-level: 6
    
    # âœ… NEW: Create GitHub issue on failure
    - name: Create issue on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let summary = 'Log file not found';
          
          try {
            summary = fs.readFileSync('logs/summary.txt', 'utf8');
          } catch (error) {
            console.log('Could not read summary file:', error.message);
          }
          
          const issueBody = `## ğŸš¨ Scheduler Failure Alert
          
          **Run Details:**
          - ğŸ“… Date: ${new Date().toISOString()}
          - ğŸ”— Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - ğŸ·ï¸ Commit: ${{ github.sha }}
          
          **Summary:**
          \`\`\`
          ${summary}
          \`\`\`
          
          **Next Steps:**
          1. Check the [workflow logs](${{github.server_url}}/${{github.repository}}/actions/runs/${{github.run_id}})
          2. Download the log artifacts for detailed analysis
          3. Fix any issues and manually trigger the workflow if needed
          
          **Auto-generated by GitHub Actions**`;
          
          // Check if issue already exists for today
          const today = new Date().toISOString().split('T')[0];
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'scheduler-failure',
            state: 'open'
          });
          
          const todayIssue = existingIssues.data.find(issue => 
            issue.title.includes(today)
          );
          
          if (!todayIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Scheduler Failed - ${today}`,
              body: issueBody,
              labels: ['scheduler-failure', 'bug', 'urgent']
            });
            console.log('Created failure issue');
          } else {
            // Update existing issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: todayIssue.number,
              body: `## Additional Failure\n\n${issueBody}`
            });
            console.log('Updated existing failure issue');
          }
    
    # âœ… NEW: Success notification (optional - can be disabled)
    - name: Log success metrics
      if: success()
      run: |
        echo "âœ… Scheduler completed successfully!"
        echo "ğŸ“Š Check the summary above for detailed metrics"
        
        # Optional: Send success webhook (uncomment if you want notifications)
        # curl -X POST "YOUR_WEBHOOK_URL" \
        #   -H "Content-Type: application/json" \
        #   -d "{
        #     \"text\": \"âœ… PubMed Scheduler Success\",
        #     \"details\": \"Emails sent: ${{ steps.scheduler.outputs.emails_sent || '0' }}\"
        #   }"

  # âœ… NEW: Optional daily health check job
  health-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' # Only run on scheduled triggers
    needs: send-subscription-updates
    steps:
    - name: Daily health summary
      run: |
        echo "ğŸ“‹ DAILY HEALTH CHECK"
        echo "===================="
        echo "ğŸ“… Date: $(date)"
        echo "âœ… Scheduler Status: ${{ needs.send-subscription-updates.result }}"
        echo "ğŸ“§ Emails Sent: ${{ needs.send-subscription-updates.outputs.emails_sent || 'Unknown' }}"
        echo "âŒ Errors: ${{ needs.send-subscription-updates.outputs.errors_count || 'Unknown' }}"
        echo ""
        
        if [ "${{ needs.send-subscription-updates.result }}" = "success" ]; then
          echo "ğŸ‰ All systems operational!"
        else
          echo "âš ï¸ Issues detected - check the logs"
        fi